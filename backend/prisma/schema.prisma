generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum WorkspaceRole {
  VIEWER
  ADMIN
  OWNER
}

model Workspace {
  id              String            @id @default(uuid())
  name            String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  aiMessages      AiMessage[]
  aiConversations AiConversation[]
  fees            Fee[]
  inventory       Inventory[]
  locations       Location[]
  orders          Order[]
  products        Product[]
  refunds         Refund[]
  members         WorkspaceMember[]
  dailyMetrics    DailyMetric[]
  skuDailyMetrics SkuDailyMetric[]
  connections     Connection[]
  syncRuns        SyncRun[]
  webhookEvents   WebhookEvent[]

  // ✅ Forecasts module
  forecasts Forecast[]

  // ✅ Plans module
  plans Plan[]
}

model User {
  id String @id @default(uuid())

  // Auth mapping
  authProvider     String
  authProviderUserId String
  email            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships WorkspaceMember[]

  @@unique([authProvider, authProviderUserId])
  @@index([email])
}

model Plan {
  id          String @id @default(uuid())
  workspaceId String

  status String  @default("draft")
  title  String?

  resultJson      Json
  assumptionsJson Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([createdAt])
}

model WorkspaceMember {
  id          String @id @default(uuid())
  workspaceId String

  /**
   * ✅ Option B:
   * userId is INTERNAL User.id (FK)
   */
  userId    String
  role      WorkspaceRole
  createdAt DateTime      @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model AiConversation {
  id          String @id @default(uuid())
  workspaceId String

  title     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages  AiMessage[]

  @@index([workspaceId])
  @@index([createdAt])
}

model AiMessage {
  id             String  @id @default(uuid())
  workspaceId    String
  conversationId String?

  role      String
  content   String
  metadata  Json?
  createdAt DateTime @default(now())

  workspace    Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  conversation AiConversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  toolCalls    AiToolCall[]

  @@index([workspaceId])
  @@index([conversationId])
}

model AiToolCall {
  id        String    @id @default(uuid())
  messageId String
  provider  String
  toolName  String
  arguments Json
  result    Json?
  createdAt DateTime  @default(now())
  message   AiMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
}

model Location {
  id          String      @id @default(uuid())
  workspaceId String
  code        String
  name        String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  inventory   Inventory[]
  orderItems  OrderItem[]
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, code])
}

model Product {
  id              String           @id @default(uuid())
  workspaceId     String
  sku             String
  name            String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  inventory       Inventory[]
  orderItems      OrderItem[]
  skuDailyMetrics SkuDailyMetric[]

  // ✅ Forecast linkage
  forecasts Forecast[]

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, sku])
}

model Inventory {
  id          String    @id @default(uuid())
  workspaceId String
  locationId  String
  productId   String
  onHand      Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  location    Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, locationId, productId])
}

model Order {
  id          String      @id @default(uuid())
  workspaceId String
  externalRef String
  orderNumber String?
  status      String
  channel     String?
  orderedAt   DateTime?
  currency    String
  subtotal    Decimal
  tax         Decimal
  shipping    Decimal
  total       Decimal
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  fees        Fee[]
  workspace   Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  items       OrderItem[]
  refunds     Refund[]

  @@unique([workspaceId, externalRef])
}

model OrderItem {
  id         String    @id @default(uuid())
  orderId    String
  lineKey    String
  productId  String
  locationId String?
  quantity   Int
  unitPrice  Decimal
  total      Decimal
  order      Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product   @relation(fields: [productId], references: [id])
  location   Location? @relation(fields: [locationId], references: [id])

  @@unique([orderId, lineKey])
  @@index([locationId])
}

model Fee {
  id          String    @id @default(uuid())
  workspaceId String
  orderId     String?
  externalRef String
  type        String
  amount      Decimal
  currency    String
  createdAt   DateTime  @default(now())
  order       Order?    @relation(fields: [orderId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, externalRef])
}

model Refund {
  id          String    @id @default(uuid())
  workspaceId String
  orderId     String?
  externalRef String
  reason      String?
  amount      Decimal
  currency    String
  createdAt   DateTime  @default(now())
  order       Order?    @relation(fields: [orderId], references: [id])
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, externalRef])
}

model DailyMetric {
  id          String   @id @default(uuid())
  workspaceId String
  day         DateTime

  revenue Decimal
  orders  Int
  units   Int

  refundsAmount Decimal
  feesAmount    Decimal
  cogsAmount    Decimal

  grossMarginAmount  Decimal
  grossMarginPercent Decimal

  stockoutsCount Int
  lowStockCount  Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, day])
  @@index([workspaceId])
  @@index([day])
}

model SkuDailyMetric {
  id          String   @id @default(uuid())
  workspaceId String
  productId   String
  day         DateTime

  unitsSold     Int
  revenue       Decimal
  refundsAmount Decimal
  feesAmount    Decimal
  avgPrice      Decimal
  stockEnd      Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, productId, day])
  @@index([workspaceId])
  @@index([productId])
  @@index([day])
}

enum ForecastLevel {
  WORKSPACE
  SKU
}

model Forecast {
  id          String  @id @default(uuid())
  workspaceId String
  productId   String?

  level  ForecastLevel
  method String

  from DateTime
  to   DateTime

  horizonDays Int

  assumptions Json
  result      Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([productId])
  @@index([level])
  @@index([createdAt])
}

enum ConnectionPlatform {
  SHOPIFY
  WOOCOMMERCE
  AMAZON
}

enum ConnectionStatus {
  ACTIVE
  DISCONNECTED
  ERROR
}

model Connection {
  id          String @id @default(uuid())
  workspaceId String

  platform ConnectionPlatform
  status   ConnectionStatus

  displayName String

  lastSyncAt DateTime?
  lastError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  secret    ConnectionSecret?
  syncRuns  SyncRun[]

  @@unique([workspaceId, platform])
  @@index([workspaceId])
  @@index([platform])
}

model ConnectionSecret {
  id           String             @id @default(uuid())
  connectionId String             @unique
  workspaceId  String
  platform     ConnectionPlatform

  authType         String
  secretCiphertext Bytes
  secretMetadata   Json?

  lastValidatedAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([platform])
  @@index([workspaceId, platform])
}

enum SyncRunStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
}

model SyncRun {
  id           String @id @default(uuid())
  workspaceId  String
  connectionId String

  status SyncRunStatus
  jobId  String?

  startedAt  DateTime?
  finishedAt DateTime?
  error      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace  Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  connection Connection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([connectionId])
  @@index([status])
  @@index([createdAt])
}

model WebhookEvent {
  id              String             @id @default(uuid())
  workspaceId     String
  platform        ConnectionPlatform
  externalEventId String

  topic   String?
  payload Json
  headers Json?

  receivedAt  DateTime  @default(now())
  processedAt DateTime?
  error       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, platform, externalEventId])
  @@index([workspaceId])
  @@index([platform])
  @@index([externalEventId])
  @@index([processedAt])
  @@index([receivedAt])
}
